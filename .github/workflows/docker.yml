name: å°†Dockeré•œåƒæ‰“åŒ…ä¸‹è½½

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker image name (e.g., ubuntu)'
        required: true
      image_tag:
        description: 'Docker image tag (e.g., 22.04)'
        required: true
        default: 'latest'
      platform:
        description: 'Docker image platform (e.g., linux/amd64, linux/arm64)'
        required: true
        default: 'linux/arm64'

jobs:
  export-and-share-docker-image:
    runs-on: Ubuntu-20.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        node-version: '20.x'
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
      with:
        node-version: '20.x'
      
    - name: Pull Docker Image
      run: docker pull --platform=${{ github.event.inputs.platform }} ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
    
    - name: Export Docker Image
      run: |
        docker save -o /tmp/image.tar ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
        echo "date2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV
        echo "å½“å‰ç›®å½•æ˜¯: $(pwd)"

    - name: ä¸Šä¼ binæ–‡ä»¶å¤¹(å›ºä»¶+ipk)å‹ç¼©åŒ…åˆ°ã€Œå¥¶ç‰›å¿«ä¼ ã€å’Œã€ŒWeTransferã€
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress /tmp/ipk.tar 2>&1 | tee cowtransfer.log
        echo "COWTRANSFER_BIN_URL=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress /tmp/ipk.tar 2>&1 | tee wetransfer.log
        echo "WETRANSFER_BIN_URL=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV   
    - name: Display WeTransfer Link
      if: success()
      run: |
        echo "ğŸ’ å¥¶ç‰›å¿«ä¼ (å›½å†…é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.COWTRANSFER_BIN_URL }}"
        echo "â›„ WeTransfer(å›½å¤–é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.WETRANSFER_BIN_URL }}"
    - name: è‡ªåŠ¨å‘å¸ƒ
      uses: ncipollo/release-action@main
      with:
        name: â¤ï¸ ${{ github.event.inputs.image_name }} 
        allowUpdates: true
        tag: ${{ env.date2 }}
        commit: main
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          é•œåƒç®€ä»‹ï¼š
            æ¶æ„ï¼š${{ github.event.inputs.platform }}
            é•œåƒï¼š${{ github.event.inputs.image_name }}
            æ ‡ç­¾ï¼š${{ github.event.inputs.image_tag }}
        artifacts: "/tmp/image.tar"
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2
