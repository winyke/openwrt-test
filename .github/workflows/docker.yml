name: 将Docker镜像打包下载

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker image name (e.g., ubuntu)'
        required: true
      image_tag:
        description: 'Docker image tag (e.g., 22.04)'
        required: true
        default: 'latest'
      platform:
        description: 'Docker image platform (e.g., linux/amd64, linux/arm64)'
        required: true
        default: 'linux/arm64'

jobs:
  export-and-share-docker-image:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        node-version: '20.x'
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
      with:
        node-version: '20.x'
      
    - name: Pull Docker Image
      run: docker pull --platform=${{ github.event.inputs.platform }} ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
    
    - name: Export Docker Image
      run: |
        docker save -o /tmp/image.tar ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
        echo "date2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV

    - name: 自动发布固件
      uses: Shopify/upload-to-release@v2.0.0
      with:
        repo_token: ${{ secrets.REPO_TOKEN }}
        name: ${{ github.event.inputs.platform }}_${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
        path: /tmp/image.tar
