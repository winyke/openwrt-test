name: 将Docker镜像打包下载

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker image name (e.g., ubuntu)'
        required: true
      image_tag:
        description: 'Docker image tag (e.g., 22.04)'
        required: true
        default: 'latest'
      platform:
        description: 'Docker image platform (e.g., linux/amd64, linux/arm64)'
        required: true
        default: 'linux/arm64'

jobs:
  export and share docker image:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        node-version: '20.x'
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
      with:
        node-version: '20.x'
      
    - name: Pull Docker Image
      run: docker pull --platform=${{ github.event.inputs.platform }} ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
    
    - name: Export Docker Image
      run: |
        # Constructing the filename in the format architecture_author_image_tag.tar
        safe_image_name="$(echo ${{ github.event.inputs.image_name }} | tr '/' '_')"
        safe_platform="$(echo ${{ github.event.inputs.platform }} | tr '/' '_')"
        filename="$safe_platform_$safe_image_name_${{github.event.inputs.image_tag}}.tar"
        docker save -o "$filename" ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}

        # Save filename to GITHUB_ENV for later steps to use
        echo "$filename"
        echo "FILENAME=$filename" >> $GITHUB_ENV

    - name: Upload to WeTransfer
      id: upload
      run: |
        echo "${{ env.FILENAME }}"
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress "${{ env.FILENAME }}" 2>&1 | tee cowtransfer.log
        echo "::warning file=奶牛快传::$(cat cowtransfer.log | grep https)"
        echo "COWTRANSFER_BIN_URL=$(cat cowtransfer.log | grep https | cut -f3 -d' ')" >> $GITHUB_ENV
        
        ./transfer wet -s -p 16 --no-progress "${{ env.FILENAME }}" 2>&1 | tee wetransfer.log
        echo "::warning file=WeTransfer::$(cat wetransfer.log | grep https)"
        echo "WETRANSFER_BIN_URL=$(cat wetransfer.log | grep https | cut -f3 -d' ')" >> $GITHUB_ENV

    - name: Display WeTransfer Link
      if: success()
      run: |
        echo "💐 奶牛快传(国内高速🚀下载)： ${{ env.COWTRANSFER_BIN_URL }}"
        echo "⛄ WeTransfer(国外高速🚀下载)： ${{ env.WETRANSFER_BIN_URL }}"
