name: Download and Export Docker Image

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker image name (e.g., ubuntu)'
        required: true
      image_tag:
        description: 'Docker image tag (e.g., 22.04)'
        required: true
        default: 'latest'
      platform:
        description: 'Docker image platform (e.g., linux/amd64, linux/arm64)'
        required: true
        default: 'linux/arm64'

jobs:
  export-and-share:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
      
    - name: Pull Docker Image
      run: docker pull --platform=${{ github.event.inputs.platform }} ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}
    
    - name: Export Docker Image
      run: |
        docker save -o image.tar ${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}

    - name: Install WeTransfer CLI
      run: |
        curl -Ls https://github.com/we-transfer/cli/releases/latest/download/wt-linux-amd64 -o /usr/local/bin/wt
        chmod +x /usr/local/bin/wt

    - name: Upload to WeTransfer
      id: upload
      run: |
        wt_result=$(wt upload image.tar --link)
        echo "::set-output name=transfer_link::$(echo "$wt_result" | grep -o 'https://we.tl/t-[A-Za-z0-9]*')"  # 提取并输出分享链接

    - name: Display WeTransfer Link
      if: success()
      run: |
        echo "The WeTransfer link to download your image is ${{ steps.upload.outputs.transfer_link }}"
